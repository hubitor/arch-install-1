#!/bin/bash

# partition the disk
parted -s --align optimal -- /dev/sda mklabel gpt
parted -s --align optimal -- /dev/sda mkpart ESP fat32 1M 50M
parted -s --align optimal -- /dev/sda set 1 boot on
parted -s --align optimal -- /dev/sda mkpart primary ext3 50M 10G
parted -s --align optimal -- /dev/sda name 2 root
parted -s --align optimal -- /dev/sda mkpart primary ext3 10G 100%
parted -s --align optimal -- /dev/sda name 3 home

# create filesystems
mkfs.vfat -F32 -s2 /dev/sda1
mkfs.ext4 /dev/sda2
mkfs.ext4 /dev/sda3

# mount partitions
mount /dev/sda2 /mnt
mkdir -p /mnt/boot
mount /dev/sda1 /mnt/boot
mkdir -p /mnt/home
mount /dev/sda3 /mnt/home

# select mirror
curl "https://www.archlinux.org/mirrorlist/?country=BR&protocol=http&ip_version=4" | sed 's/#Server/Server/g' > /etc/pacman.d/mirrorlist

# install base system
pacstrap /mnt base base-devel

# generate fstab
genfstab -U -p /mnt >> /mnt/etc/fstab

# install packages
arch-chroot /mnt pacman -S --noconfirm dosfstools efibootmgr gummiboot bash-completion

# set up locale
arch-chroot /mnt echo "pt_BR.UTF-8 UTF-8" > /etc/locale.gen
arch-chroot /mnt locale-gen
arch-chroot /mnt localectl set-locale LANG=pt_BR.UTF-8
# arch-chroot /mnt export LANG=pt_BR.UTF-8

# set up time zone and clock
arch-chroot /mnt ln -s /usr/share/zoneinfo/America/Sao_Paulo /etc/localtime
arch-chroot /mnt hwclock --systohc --utc

# set up hostname and users
arch-chroot /mnt echo "Turing" > /etc/hostname
arch-chroot /mnt echo "root:password" | arch-chroot /mnt chpasswd --root /
arch-chroot /mnt useradd -m -g users -G wheel,storage,power -s /bin/bash stenny
arch-chroot /mnt echo $'password\n' | arch-chroot /mnt passwd stenny

# install low-level
arch-chroot /mnt mkinitcpio -p linux
arch-chroot /mnt gummiboot --path=/boot install
arch-chroot /mnt echo $'title          Arch Linux\nlinux          /vmlinuz-linux\ninitrd         /initramfs-linux.img\noptions        root=/dev/sda2 rw' > /boot/loader/entries/arch.conf
arch-chroot /mnt echo $'default	arch\ntimeout	5' > /boot/loader/loader.conf

echo $'Good luck!\n	* Edit the /etc/sudoers file and uncomment the %wheel line.\n * \nHere are your bash statistics:'