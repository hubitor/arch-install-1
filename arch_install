#!/bin/bash

# partition the disk
parted -s --align optimal -- /dev/sda mklabel gpt
parted -s --align optimal -- /dev/sda mkpart ESP fat32 1M 50M
parted -s --align optimal -- /dev/sda set 1 boot on
parted -s --align optimal -- /dev/sda mkpart primary ext3 50M 10G
parted -s --align optimal -- /dev/sda name 2 root
parted -s --align optimal -- /dev/sda mkpart primary ext3 10G 100%
parted -s --align optimal -- /dev/sda name 3 home

# create filesystems
mkfs.vfat -F32 /dev/sda1
mkfs.ext4 /dev/sda2
mkfs.ext4 /dev/sda3

# mount partitions
mount /dev/sda2 /mnt
mkdir -p /mnt/boot
mount /dev/sda1 /mnt/boot
mkdir -p /mnt/home
mount /dev/sda3 /mnt/home

# select mirror
curl "https://www.archlinux.org/mirrorlist/?country=BR&protocol=http&ip_version=4" | sed 's/#Server/Server/g' > /etc/pacman.d/mirrorlist

# install base system
pacstrap /mnt base base-devel

# generate fstab
genfstab -U -p /mnt >> /mnt/etc/fstab

# install packages
arch-chroot /mnt pacman -S --noconfirm dosfstools efibootmgr grub bash-completion

# set up locale
arch-chroot /mnt echo "pt_BR.UTF-8 UTF-8" > /mnt/etc/locale.gen
arch-chroot /mnt locale-gen
arch-chroot /mnt echo "pt_BR.UTF-8" > /mnt/etc/locale.conf
# arch-chroot /mnt export LANG=pt_BR.UTF-8

# set up time zone and clock
arch-chroot /mnt ln -s /usr/share/zoneinfo/America/Sao_Paulo /etc/localtime
arch-chroot /mnt hwclock --systohc --utc

# set up hostname and users
arch-chroot /mnt echo "Turing" > /mnt/etc/hostname
arch-chroot /mnt passwd
arch-chroot /mnt useradd -m -g users -G wheel,storage,power -s /bin/bash stenny
arch-chroot /mnt passwd stenny
arch-chroot /mnt sed -i "s/# %wheel ALL=(ALL) ALL/%wheel ALL=(ALL) ALL/" /etc/sudoers

# kernel and bootloader
arch-chroot /mnt mkinitcpio -p linux
arch-chroot /mnt grub-install --target=x86_64-efi --efi-directory=/boot --bootloader-id=Arch --recheck
arch-chroot /mnt grub-mkconfig -o /boot/grub/grub.cfg